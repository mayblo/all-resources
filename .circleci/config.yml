version: 2.1

jobs:
  cortex-code-scan:
    docker:
      - image: cimg/base:stable
    environment:
      CORTEX_API_URL: https://api-viso-8vocygkchsephm7mczadnc.xdr-qa2-uat.us.paloaltonetworks.com/
      MIN_LOG_LEVEL: DEBUG
    steps:
      - checkout

      - run:
          name: Download cortexcli
          command: |
            set -x
            crtx_resp=$(curl "https://api-viso-8vocygkchsephm7mczadnc.xdr-qa2-uat.us.paloaltonetworks.com/public_api/v1/unified-cli/releases/download-link?os=linux&architecture=amd64" \
              -H "x-xdr-auth-id: $CORTEX_API_KEY_ID" \
              -H "Authorization: ${CORTEX_API_KEY}")
            crtx_url=$(echo $crtx_resp | jq -r ".signed_url")
            curl -o cortexcli $crtx_url
            chmod +x cortexcli
            ./cortexcli --version

      - run:
          name: Install patchelf
          command: sudo apt-get update && sudo apt-get install -y patchelf

      - run:
          name: Install Node.js 22
          command: |
            curl -fsSL https://deb.nodesource.com/setup_22.x | sudo -E bash -
            sudo apt-get install -y nodejs
            node -v

      - run:
          name: Show file list
          command: ls -la

      - run:
          name: Run Cortex CLI Code Scan
          command: |
            export FIXED_MODULE_VERSION_APPSEC=0.595.0
            ./cortexcli \
              --api-base-url "${CORTEX_API_URL}" \
              --api-key "${CORTEX_API_KEY}" \
              --api-key-id "${CORTEX_API_KEY_ID}" \
              code scan \
              --directory "$(pwd)" \
              --repo-id "${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}" \
              --branch "${CIRCLE_BRANCH}" \
              --source "CIRCLE_CI" \
              --upload-mode "no-upload" \
              --framework "sca" \
              --create-repo-if-missing

workflows:
  cortex-scan-workflow:
    jobs:
      - cortex-code-scan
